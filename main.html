<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©”ì¸ - ë‚´íƒ“ë„¤íƒ“</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body { margin: 0; background-color: #f5f5f5; font-family: 'Pretendard', sans-serif; color: #333; }
        
        .mobile-container {
            width: 100%; max-width: 430px; min-height: 100vh; margin: 0 auto;
            background-color: #ffffff; position: relative;
            display: flex; flex-direction: column; align-items: center; 
            padding-top: 60px; /* ìµœìƒë‹¨ ì•½ 1cm ì—¬ìœ  */
            box-sizing: border-box;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }

        /* ğŸ”” ì•Œë¦¼ ì•„ì´ì½˜ */
        .notification-header {
            position: absolute; top: 20px; right: 20px; z-index: 100;
        }
        .noti-btn {
            background: none; border: none; font-size: 24px; cursor: pointer; position: relative;
        }
        .noti-badge {
            position: absolute; top: -2px; right: -2px; background: red; color: white;
            font-size: 10px; width: 16px; height: 16px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: bold;
            display: none; 
        }

        .noti-dropdown {
            display: none; position: absolute; top: 55px; right: 20px; width: 280px;
            background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border: 1px solid #eee; overflow-y: auto; max-height: 400px; z-index: 101;
        }
        .noti-item {
            padding: 15px; border-bottom: 1px solid #f9f9f9; font-size: 13px; line-height: 1.4;
        }
        .noti-item:last-child { border-bottom: none; }
        .noti-item .time { color: #999; font-size: 11px; margin-top: 5px; }
        .noti-title { font-weight: bold; margin-bottom: 3px; display: block; }

        /* ì‹¤ì‹œê°„ ìƒíƒœ ë°” */
        .live-status {
            background: rgba(0, 200, 0, 0.1); border: 1px solid #00aa00; color: #00aa00;
            padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; margin-bottom: 8px;
        }

        /* ìœ ì € ì •ë³´ ë°” */
        .user-status-bar {
            background: #f9f9f9; border: 1px solid rgba(255, 215, 0, 0.5);
            padding: 8px 15px; border-radius: 12px; display: flex; gap: 10px;
            font-size: 12px; 
            margin-bottom: 20px; /* ë¡œê³ ì™€ì˜ ê°„ê²© 0.5cm */
            align-items: center; color: #333;
        }
        .rank-text { color: #9d4edd; font-weight: bold; }
        .coin-text { color: #b8860b; font-weight: bold; }

        /* ë¡œê³  ìŠ¤íƒ€ì¼ */
        .logo { 
            font-size: 24px; font-weight: 900; 
            margin-bottom: 20px; /* ë¡œê³  ë°”ë¡œ ë°‘ ì²« ë²ˆì§¸ ì„ ê³¼ì˜ ê°„ê²© */
            text-align: center; line-height: 1.1; color: #333; 
        }
        .logo span { font-size: 28px; }

        /* ê°€ë¡œ ê²½ê³„ì„  ìŠ¤íƒ€ì¼ */
        .divider {
            width: 90%;
            height: 1px;
            background-color: #eee;
        }

        /* ë²„íŠ¼ 3x2 ê·¸ë¦¬ë“œ ì„¤ì • */
        .menu-group { 
            width: 90%; 
            margin-top: 20px; /* ë‘ ë²ˆì§¸ ì„ ê³¼ ë²„íŠ¼ ì‚¬ì´ì˜ ê°„ê²© */
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            grid-template-rows: repeat(2, 1fr);    
            gap: 10px; 
        }
        
        .menu-btn {
            background: #ffffff; border: 1px solid #ddd; 
            padding: 15px 5px; border-radius: 12px; color: #333;
            text-decoration: none; font-size: 13px; font-weight: bold; 
            text-align: center; transition: 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 5px;
        }
        .menu-btn:active { background-color: #f9f9f9; transform: scale(0.95); }
        .tower-btn { border-color: #ffd700; color: #b8860b; }
    </style>
</head>
<body>
    <div class="mobile-container">
        <div class="notification-header">
            <button class="noti-btn" onclick="toggleNoti(event)">
                ğŸ”” <span class="noti-badge" id="notiCount">0</span>
            </button>
            <div class="noti-dropdown" id="notiDropdown"></div>
        </div>

        <div class="live-status" id="liveUserBadge">â— ì‹¤ì‹œê°„ ì ‘ì† ë°°ì‹¬ì›: ì—°ê²° ì¤‘...</div>

        <div class="user-status-bar">
            <div class="status-item"><span style="color: #666;">ë“±ê¸‰:</span> <span id="mainRank" class="rank-text">ë¡œë”© ì¤‘...</span></div>
            <div style="width: 1px; height: 12px; background: #ddd;"></div>
            <div class="status-item"><span style="color: #666;">ë³´ìœ :</span> <span class="coin-text">ğŸŸ¡ <span id="mainCoin">0</span></span></div>
        </div>

        <div class="logo">ë‚´íƒ“ <span>âš–ï¸</span> ë„¤íƒ“</div>

        <div class="divider"></div>
        <div style="height: 100px;"></div> <div class="divider"></div>

        <div class="menu-group">
            <a href="write.html" class="menu-btn"><span>âš–ï¸</span>ì‚¬ê±´ ì ‘ìˆ˜</a>
            <a href="list.html" class="menu-btn"><span>ğŸ“œ</span>ê¸°ë¡ì‹¤</a>
            <a href="retry.html" class="menu-btn"><span>ğŸ”¨</span>ì¬ì‹¬ë‹¨</a>
            <a href="mypage.html" class="menu-btn"><span>ğŸ‘¤</span>ë§ˆì´í˜ì´ì§€</a>
            <a href="#" class="menu-btn" style="opacity: 0.5; font-size: 11px;"><span>â“</span>ì¤€ë¹„ì¤‘</a>
            <a href="#" class="menu-btn" style="opacity: 0.5; font-size: 11px;"><span>â“</span>ì¤€ë¹„ì¤‘</a>
        </div>
    </div>

    <script>
        // Firebase ì„¤ì • (ê¸°ì¡´ í”„ë¡œì íŠ¸ ID ìœ ì§€)
        const firebaseConfig = {
            projectId: "sxsx-75c73",
            storageBucket: "sxsx-75c73.appspot.com",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        async function updateLastActive() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser || !currentUser.nickname) return;
            try {
                await db.collection('users').doc(currentUser.nickname).set({
                    lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                    nickname: currentUser.nickname
                }, { merge: true });
            } catch (e) { console.error("í™œë™ ê¸°ë¡ ì‹¤íŒ¨:", e); }
        }

        async function updateLiveUsers() {
            try {
                const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
                const snapshot = await db.collection('users').where('lastActive', '>=', fiveMinutesAgo).get();
                const count = snapshot.size || 1; 
                document.getElementById('liveUserBadge').innerText = `â— ì‹¤ì‹œê°„ ì ‘ì† ë°°ì‹¬ì›: ${count}ëª…`;
            } catch (error) { document.getElementById('liveUserBadge').innerText = `â— ì‹¤ì‹œê°„ ì ‘ì† ë°°ì‹¬ì›: 1ëª…`; }
        }

        function initSecurity() {
            if (!localStorage.getItem('currentUser')) { location.replace('index.html'); return; }
            history.pushState(null, null, location.href);
            window.onpopstate = function() {
                history.pushState(null, null, location.href);
                alert("ë¡œê·¸ì•„ì›ƒí•˜ì‹œë ¤ë©´ ë§ˆì´í˜ì´ì§€ë¥¼ ì´ìš©í•´ì£¼ì„¸ìš”.");
            };
        }

        function toggleNoti(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('notiDropdown');
            const isVisible = dropdown.style.display === 'block';
            dropdown.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) document.getElementById('notiCount').style.display = 'none';
        }

        window.onclick = function(event) {
            if (!event.target.closest('.notification-header')) {
                document.getElementById('notiDropdown').style.display = 'none';
            }
        }

        function checkNewNotifications() {
            const cases = JSON.parse(localStorage.getItem('myCases') || '[]');
            let notifications = JSON.parse(localStorage.getItem('userNoti') || '[]');
            let hasNew = false;
            const now = Date.now();
            cases.forEach(item => {
                const isClosed = (item.endTime - now) <= 0;
                if (isClosed && !item.notified) {
                    let msg = "";
                    const currentNick = JSON.parse(localStorage.getItem('currentUser')).nickname;
                    if (item.authorName === currentNick) msg = `âš–ï¸ íŒê²° ì¢…ë£Œ: '${item.title}' ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.`;
                    else if (item.voted) msg = `ğŸ—³ï¸ ê²°ê³¼ ì•Œë¦¼: ì°¸ì—¬í•˜ì‹  '${item.title}' ì¢…ë£Œ.`;
                    
                    if (msg) {
                        notifications.unshift({ title: "íŒê²° ì¢…ë£Œ", content: msg, time: "ë°©ê¸ˆ ì „" });
                        item.notified = true;
                        hasNew = true;
                    }
                }
            });
            if (hasNew) {
                localStorage.setItem('userNoti', JSON.stringify(notifications));
                localStorage.setItem('myCases', JSON.stringify(cases));
            }
            renderNotiList(notifications);
        }

        function renderNotiList(notifications) {
            const listContainer = document.getElementById('notiDropdown');
            const badge = document.getElementById('notiCount');
            if (!notifications || notifications.length === 0) {
                listContainer.innerHTML = '<div class="noti-item" style="text-align:center; color:#999;">ìƒˆ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                badge.style.display = 'none';
            } else {
                badge.innerText = notifications.length > 9 ? '9+' : notifications.length;
                badge.style.display = 'flex';
                listContainer.innerHTML = notifications.map(n => `
                    <div class="noti-item">
                        <span class="noti-title">${n.title}</span>
                        ${n.content}
                        <div class="time">${n.time}</div>
                    </div>
                `).join('');
            }
        }

        function loadMainUserInfo() {
            const userData = JSON.parse(localStorage.getItem('userData')) || { coin: 0 };
            document.getElementById('mainCoin').innerText = (userData.coin || 0).toLocaleString();
            const lp = parseInt(localStorage.getItem('userPoints') || '0');
            const badgeEl = document.getElementById('mainRank');
            let rankName = "ì‹ ì… ë°°ì‹¬ì›";
            if (lp >= 50000) rankName = "ëª…ì˜ˆ ëŒ€ë²•ê´€";
            else if (lp >= 15000) rankName = "ë¶€ì¥íŒì‚¬";
            else if (lp >= 5000) rankName = "í‰íŒì‚¬";
            else if (lp >= 1000) rankName = "ì‚¬ë²•ì—°ìˆ˜ìƒ";
            badgeEl.innerText = rankName;
            checkNewNotifications();
        }

        window.onload = function() {
            initSecurity();
            updateLastActive(); 
            updateLiveUsers();  
            loadMainUserInfo();
            setInterval(updateLiveUsers, 30000); 
        };
    </script>
</body>
</html>