<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ë§¤ì¼ì§€ ì•„ì¹´ì´ë¸Œ</title>
    <style>
        /* [ìŠ¤íƒ€ì¼ ê°€ì´ë“œ] ë©”ì¸ ë° ë¦¬ìŠ¤íŠ¸ ë””ìì¸ ìœ ì§€ */
        body { margin: 0; background-color: #121212; color: #e0e0e0; font-family: 'Pretendard', sans-serif; padding: 20px; display: flex; justify-content: center; }
        .list-container { width: 100%; max-width: 450px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header h2 { color: #f3ba2f; margin: 0; font-size: 22px; cursor: pointer; } 
        .header h2 a { color: inherit; text-decoration: none; } 
        .filter-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #333; background: #1e1e1e; color: #888; cursor: pointer; font-size: 13px; font-weight: bold; transition: 0.2s; }
        .tab-btn.active { border-color: #f3ba2f; color: #f3ba2f; background: rgba(243, 186, 47, 0.1); }
        #logList { display: flex; flex-direction: column; gap: 12px; }
        .log-card { background: #1e1e1e; border-radius: 15px; padding: 18px 20px; border-left: 6px solid #444; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; text-decoration: none; color: inherit; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .floating-btn { position: fixed; bottom: 30px; right: 20px; width: 60px; height: 60px; background: #f3ba2f; color: #000; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(243, 186, 47, 0.4); z-index: 1000; }

        /* [ì´ì‹] calculator.htmlì˜ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ê·¸ëŒ€ë¡œ ë³µì‚¬ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 1000; padding: 20px; box-sizing: border-box; }
        .modal-content { background: #1e1e1e; width: 100%; max-width: 400px; padding: 25px; border-radius: 20px; max-height: 90vh; overflow-y: auto; border: 1px solid #333; text-align: left; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-btn { background: none; border: none; color: #aaa; font-size: 24px; cursor: pointer; }
        .journal-preview { background: #2b2b2b; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 13px; border: 1px dashed #444; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; font-size: 14px; margin-bottom: 8px; color: #aaa; }
        .modal-content input, .modal-content textarea { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #333; background: #2b2b2b; color: #fff; font-size: 16px; box-sizing: border-box; font-family: inherit; }
        .modal-content textarea { resize: vertical; min-height: 80px; }
        .btn-save { width: 100%; padding: 15px; border-radius: 10px; border: none; background: #f3ba2f; color: #000; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; }
        
        /* ì‹œê°„ í‘œì‹œ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .log-duration { font-size: 11px; color: #f3ba2f; font-weight: 500; margin-left: 8px; }

        /* [ì¶”ê°€] ê´€ë¦¬ì ë²„íŠ¼ ì´ˆê¸° ìˆ¨ê¹€ (ê¹œë¹¡ì„ ë°©ì§€) */
        .floating-btn, .btn-save { display: none; }
    </style>
</head>
<body>

<div class="list-container">
    <div class="header"><h2><a href="index.html">Trade Archive</a></h2></div>
    <div class="filter-tabs">
        <button class="tab-btn active" onclick="window.loadLogs('all', this)">ì „ì²´</button>
        <button class="tab-btn" onclick="window.loadLogs('profit', this)">ìˆ˜ìµ</button>
        <button class="tab-btn" onclick="window.loadLogs('loss', this)">ì†ì‹¤</button>
    </div>
    <div id="logList"><div style="text-align:center; color:#f3ba2f;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
</div>

<div class="floating-btn" id="adminFloatBtn" onclick="window.openJournal()">+</div>

<div class="modal-overlay" id="journalModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin:0; color:#f3ba2f;">New Trade Journal</h3>
            <button class="close-btn" onclick="window.closeJournal()">&times;</button>
        </div>
        <div class="journal-preview">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span>í¬ì§€ì…˜: <b id="j-dir">-</b></span>
                <span>ì†ì ˆ ì‹œ ì†ì‹¤ë¥ : <b id="j-loss">0%</b></span>
            </div>
        </div>
        <div class="input-group"><label>ì½”ì¸ ì¢…ëª©</label><input type="text" id="journalCoin" placeholder="ì˜ˆ: BTC, ETH"></div>
        <div class="input-group"><label>ì§„ì…ê°€</label><input type="number" id="journalEntry" oninput="updateJournalCalc()"></div>
        <div class="input-group"><label>ì†ì ˆê°€</label><input type="number" id="journalStop" oninput="updateJournalCalc()"></div>
        <div class="input-group"><label>ë°°ìœ¨ (Leverage)</label><input type="number" id="journalLev" placeholder="ì˜ˆ: 20" oninput="updateJournalCalc()"></div>
        <div class="input-group"><label>ì°¨íŠ¸ ì´ë¯¸ì§€</label><input type="file" id="journalImg" accept="image/*" style="font-size:12px;"></div>
        <div class="input-group"><label>ì§„ì… ê·¼ê±°</label><textarea id="journalReason"></textarea></div>
        <button class="btn-save" id="adminSaveBtn" onclick="saveJournal()">ì¼ì§€ ì €ì¥</button>
    </div>
</div>
<script>
    window.addEventListener('load', () => {
        const role = localStorage.getItem('my_app_role');
        
        // [ìˆ˜ì •] ì£¼ì¸ë‹˜('master')ì¼ ë•Œë§Œ ë²„íŠ¼ë“¤ì„ ë…¸ì¶œì‹œí‚¤ëŠ” ë¡œì§ìœ¼ë¡œ ë³€ê²½ (ë³´ì•ˆ ê°•í™”)
        if (role === 'master') {
            const adminItems = document.querySelectorAll('#adminFloatBtn, #adminSaveBtn');
            adminItems.forEach(el => {
                if(el) {
                    if(el.classList.contains('floating-btn')) el.style.display = 'flex';
                    else el.style.display = 'block';
                }
            });
        }
    });
</script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAqbLB-bnniXhNj0XqtD0DlkWhk_2_0PkU",
        authDomain: "sxsx-75c73.firebaseapp.com",
        projectId: "sxsx-75c73",
        storageBucket: "sxsx-75c73.firebasestorage.app",
        messagingSenderId: "401139729279",
        appId: "1:401139729279:web:2a41b315873137bfeb104a",
        measurementId: "G-1200YV6S6K"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    function parseDate(dateStr) {
        if (!dateStr) return null;
        if (typeof dateStr === 'number') return dateStr;
        const isPM = dateStr.includes("ì˜¤í›„");
        const numbers = dateStr.match(/\d+/g).map(Number);
        if (!numbers || numbers.length < 5) return null;
        let year = numbers[0], month = numbers[1] - 1, day = numbers[2], hour = numbers[3], minute = numbers[4], second = numbers[5] || 0;
        if (isPM && hour < 12) hour += 12;
        if (!isPM && hour === 12) hour = 0;
        return new Date(year, month, day, hour, minute, second).getTime();
    }

    function getDuration(startTs, endStr) {
        if (!startTs || !endStr) return "";
        const startTime = parseDate(startTs), endTime = parseDate(endStr);
        if (!startTime || !endTime) return "â±ï¸ 0ë¶„";
        const diffMs = endTime - startTime;
        if (diffMs < 0) return "â±ï¸ 0ë¶„";
        const totalMinutes = Math.floor(diffMs / 60000);
        const days = Math.floor(totalMinutes / (60 * 24)), hours = Math.floor((totalMinutes % (60 * 24)) / 60), mins = totalMinutes % 60;
        let result = "â±ï¸ ";
        if (days > 0) result += days + "ì¼ ";
        if (hours > 0) result += hours + "ì‹œê°„ ";
        if (mins > 0 || (days === 0 && hours === 0)) result += mins + "ë¶„";
        return result.trim();
    }

    window.updateJournalCalc = function() {
        const entry = parseFloat(document.getElementById('journalEntry').value);
        const stop = parseFloat(document.getElementById('journalStop').value);
        const lev = parseFloat(document.getElementById('journalLev').value) || 0;
        if (!entry || !stop) return;
        const isLong = entry > stop;
        const priceChangePercent = (Math.abs(entry - stop) / entry) * 100;
        const totalLossPercent = (priceChangePercent * lev) + (lev / 10);
        const dirEl = document.getElementById('j-dir');
        dirEl.innerText = isLong ? "ë¡± ğŸŸ¢" : "ìˆ ğŸ”´";
        dirEl.style.color = isLong ? "#00c087" : "#ff4d4d";
        document.getElementById('j-loss').innerText = totalLossPercent.toFixed(2) + "%";
    };

    window.openJournal = function() {
        document.getElementById('journalModal').style.display = 'flex';
    };

    window.closeJournal = function() { 
        document.getElementById('journalModal').style.display = 'none'; 
    };

    window.saveJournal = async function() {
        const imgFile = document.getElementById('journalImg').files[0];
        let imageUrl = null;
        const saveBtn = document.querySelector('.btn-save');
        saveBtn.innerText = "ì„œë²„ ì €ì¥ ì¤‘...";
        saveBtn.disabled = true;

        try {
            if (imgFile) {
                const reader = new FileReader();
                const fileData = await new Promise((resolve) => {
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(imgFile);
                });
                const storageRef = ref(storage, 'trade_images/' + Date.now());
                await uploadString(storageRef, fileData, 'data_url');
                imageUrl = await getDownloadURL(storageRef);
            }

            const entryVal = document.getElementById('journalEntry').value;
            const levVal = document.getElementById('journalLev').value;

            const journalData = {
                coinName: document.getElementById('journalCoin').value || "Unknown",
                entry: entryVal,
                stop: document.getElementById('journalStop').value,
                leverage: levVal,
                direction: document.getElementById('j-dir').innerText,
                expectedLoss: document.getElementById('j-loss').innerText,
                reason: document.getElementById('journalReason').value,
                date: new Date().toLocaleString(),
                img: imageUrl,
                status: "ì§„í–‰ ì¤‘",
                endDate: null,
                timestamp: Date.now(),
                partialProfit: 0,
                tradeHistory: [{
                    type: "ìµœì´ˆ ì§„ì…",
                    timestamp: Date.now(),
                    date: new Date().toLocaleString(),
                    leverage: levVal,
                    avgPrice: entryVal
                }] 
            };
            
            await addDoc(collection(db, "tradeLogs"), journalData);
            window.closeJournal();
            window.loadLogs('refresh');
        } catch (error) {
            alert("ì„œë²„ ì €ì¥ ì‹¤íŒ¨!");
            saveBtn.innerText = "ì¼ì§€ ì €ì¥";
            saveBtn.disabled = false;
        }
    };

    let allLogs = [];
    window.loadLogs = async function(filter = 'all', btnElement = null) {
        const logList = document.getElementById('logList');
        if (btnElement) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            btnElement.classList.add('active');
        }
        try {
            if (allLogs.length === 0 || filter === 'refresh') {
                const q = query(collection(db, "tradeLogs"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                allLogs = [];
                querySnapshot.forEach((doc) => { allLogs.push({ id: doc.id, ...doc.data() }); });
            }
            let filteredLogs = [...allLogs];
            if (filter === 'profit') filteredLogs = allLogs.filter(log => log.status === "ì¢…ë£Œ" && parseFloat(log.actualProfit) > 0);
            else if (filter === 'loss') filteredLogs = allLogs.filter(log => log.status === "ì¢…ë£Œ" && parseFloat(log.actualProfit) < 0);

            logList.innerHTML = filteredLogs.map((log) => {
                const isLong = log.direction && log.direction.includes("ë¡±");
                const borderColor = isLong ? "#00c087" : "#ff4d4d";
                
                let durationSpan = "";
                if (log.status !== "ì§„í–‰ ì¤‘" && log.endDate) {
                    durationSpan = `<span class="log-duration">${getDuration(log.timestamp || log.date, log.endDate)}</span>`;
                }

                const clickHandler = log.status === 'ì§„í–‰ ì¤‘' 
                    ? `onclick="alert('ì§„í–‰ ì¤‘ì¸ í¬ì§€ì…˜ì€ ë§ˆê° í›„ ìƒì„¸ ë‚´ìš©ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); return false;"` 
                    : `href="bctdetail.html?id=${log.id}"`;

                return `
                    <a ${clickHandler} class="log-card" style="border-left-color: ${borderColor}">
                        <div style="text-align:left;">
                            <div style="color:${borderColor}; font-weight:bold;">${log.direction} ${log.leverage}x <span style="background:#333; color:#fff; padding:2px 5px; border-radius:5px; font-size:12px; margin-left:5px;">${log.coinName}</span></div>
                            <div style="display: flex; align-items: center; margin-top: 5px;">
                                <span style="color:#fff; font-size:11px;">${log.date}</span>
                                ${durationSpan}
                            </div>
                        </div>
                        <div style="font-weight:bold; color:${log.status === 'ì§„í–‰ ì¤‘' ? '#aaa' : (parseFloat(log.actualProfit) >= 0 ? '#24a0ed' : '#ff4d4d')}">
                            ${log.status === 'ì§„í–‰ ì¤‘' ? 'ì§„í–‰ ì¤‘' : (parseFloat(log.actualProfit) > 0 ? '+' : '') + log.actualProfit + '%'}
                        </div>
                    </a>`;
            }).join('');
        } catch (e) { logList.innerHTML = "ì˜¤ë¥˜ ë°œìƒ"; }
    };
    window.loadLogs('refresh');
</script>
</body>
</html>