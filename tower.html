<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë…¼ìŸì˜ íƒ‘ - ë‚´íƒ“ë„¤íƒ“</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ë™ì¼ (ê±´ë“œë¦¬ì§€ ì•ŠìŒ) */
        body { margin: 0; background-color: #1a1a1a; font-family: 'Pretendard', sans-serif; color: #ffffff; }
        .mobile-container {
            width: 100%; max-width: 430px; min-height: 100vh; margin: 0 auto;
            display: flex; flex-direction: column; padding: 40px 20px; box-sizing: border-box;
            background: linear-gradient(180deg, #1a1a1a 0%, #2d3436 100%);
        }
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .back-btn { font-size: 28px; color: #fff; text-decoration: none; cursor: pointer; }

        .floor-selector-container {
            margin: 20px 0 50px 0;
            padding: 10px 0;
            overflow-x: auto;
            display: flex;
            gap: 12px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .floor-selector-container::-webkit-scrollbar { display: none; }

        .floor-dot {
            flex: 0 0 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: 0.3s;
            color: #888;
        }
        .floor-dot.current {
            background: #ffd700;
            color: #000;
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }
        .floor-dot.locked { opacity: 0.3; cursor: not-allowed; }
        .floor-dot.completed { border-color: #00b894; color: #00b894; }

        .tower-status { text-align: center; margin-bottom: 10px; }
        .floor-num { font-size: 32px; font-weight: 900; color: #ffd700; text-shadow: 0 0 10px rgba(255,215,0,0.5); }
        .survival-badge { background: #00b894; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; color: white; display: inline-block; }
        .eliminated-badge { background: #d63031 !important; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; color: white; display: inline-block; }
        .debate-card { background: rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 30px 20px; text-align: center; border: 1px solid rgba(255,255,255,0.2); margin-bottom: 20px; min-height: 250px; display: flex; flex-direction: column; justify-content: center; }
        .timer { font-size: 16px; color: #ffd700; font-weight: bold; margin-bottom: 10px; }
        .question { font-size: 16px; font-weight: 500; line-height: 1.7; word-break: keep-all; text-align: left; white-space: pre-wrap; color: #ffffff; }
        .result-box { margin-top: 15px; display: none; }
        .gauge-bar { height: 25px; width: 100%; background: #444; border-radius: 12px; overflow: hidden; display: flex; position: relative; border: 1px solid rgba(255,255,255,0.1); }
        .gauge-my { height: 100%; background: #0984e3; transition: width 0.5s ease-in-out; }
        .gauge-your { height: 100%; background: #e84393; transition: width 0.5s ease-in-out; }
        .gauge-text { position: absolute; width: 100%; display: flex; justify-content: space-between; padding: 0 10px; box-sizing: border-box; line-height: 25px; font-size: 12px; font-weight: bold; }
        .vote-group { display: flex; flex-direction: column; gap: 15px; width: 100%; margin-bottom: 20px; }
        .vote-btn { padding: 20px; border-radius: 15px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; color: white; }
        .btn-my { background: #0984e3; border: 2px solid transparent; }
        .btn-your { background: #e84393; border: 2px solid transparent; }
        .vote-btn.selected { border-color: #ffffff; box-shadow: 0 0 15px rgba(255,255,255,0.5); }
        .vote-btn:disabled { background: #444; cursor: not-allowed; opacity: 0.5; }
        .revive-btn { background: #ffd700; color: #000; padding: 15px; border-radius: 15px; font-weight: bold; border: none; margin-top: 20px; cursor: pointer; width: 100%; }
        .comment-section { margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; }
        .comment-input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .comment-input { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; padding: 10px; color: white; font-size: 14px; }
        .comment-submit { background: #ffd700; border: none; border-radius: 10px; padding: 0 15px; font-weight: bold; cursor: pointer; }
        .best-label { color: #ffd700; font-size: 12px; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        .comment-list { display: flex; flex-direction: column; gap: 12px; }
        .comment-card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 12px; border: 1px solid rgba(255,255,255,0.1); }
        .comment-header { display: flex; justify-content: space-between; font-size: 11px; color: #888; margin-bottom: 6px; }
        .comment-user { color: #aaa; font-weight: bold; }
        .comment-content { font-size: 14px; line-height: 1.5; color: #eee; margin-bottom: 8px; }
        .comment-footer { display: flex; justify-content: flex-end; }
        .like-btn { background: none; border: 1px solid rgba(255,215,0,0.3); color: #ffd700; border-radius: 15px; padding: 2px 10px; font-size: 11px; cursor: pointer; }
        .reward-info { margin-top: 40px; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 15px; font-size: 13px; text-align: center; }
    </style>
</head>
<body>
    <div class="mobile-container">
        <div class="header">
            <div class="back-btn" onclick="location.href='main.html'">&lt;</div>
            <div id="userCoinDisplay" style="color: #ffd700; font-weight: bold;">ğŸŸ¡ 0</div>
        </div>

        <div class="floor-selector-container" id="floorBar"></div>

        <div class="tower-status">
            <div id="currentFloor" class="floor-num">1ì¸µ</div>
            <span id="statusBadge" class="survival-badge">ìƒì¡´ ì¤‘</span>
        </div>

        <div class="debate-card">
            <div class="timer" id="roundTimer">ë‚¨ì€ ì‹œê°„ ê³„ì‚° ì¤‘...</div>
            <div class="question" id="debateQuestion">ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
            
            <div id="resultBox" class="result-box">
                <div class="gauge-bar">
                    <div id="barMy" class="gauge-my"></div>
                    <div id="barYour" class="gauge-your"></div>
                    <div class="gauge-text">
                        <span id="textMy">ë‚´ íƒ“ 48%</span>
                        <span id="textYour">ë„¤ íƒ“ 52%</span>
                    </div>
                </div>
                <div id="winTag" style="color:#ffd700; font-size:12px; margin-top:8px; font-weight:bold;">íŒê²° ì™„ë£Œ</div>
            </div>
        </div>

        <div class="vote-group" id="voteGroup">
            <button id="btnMy" class="vote-btn btn-my" onclick="castVote('my')">ë‚´ íƒ“ì´ë‹¤</button>
            <button id="btnYour" class="vote-btn btn-your" onclick="castVote('your')">ë„¤ íƒ“ì´ë‹¤</button>
        </div>

        <button id="reviveBtn" class="revive-btn" style="display: none;" onclick="revive()">ğŸŸ¡ 100 ì½”ì¸ìœ¼ë¡œ ë¶€í™œí•˜ê¸°</button>

        <div class="comment-section">
            <div class="comment-input-group">
                <input type="text" id="commentInput" class="comment-input" placeholder="ë…¼ë¦¬ì ì¸ ëŒ“ê¸€ë¡œ ì„¤ë“í•´ë³´ì„¸ìš”...">
                <button class="comment-submit" onclick="addComment()">ë“±ë¡</button>
            </div>
            <div class="best-label">ğŸ‘‘ ë² ìŠ¤íŠ¸ íŒê²°ë¬¸</div>
            <div id="bestCommentList" class="comment-list" style="margin-bottom: 25px;"></div>
            <div class="best-label" style="color: #888;">ìµœì‹  ëŒ“ê¸€</div>
            <div id="commentList" class="comment-list"></div>
        </div>

        <div class="reward-info">
            í˜„ì¬ ì¸µ í†µê³¼ ë³´ìƒ: <span id="rewardCoin" style="color: #ffd700;">10ê°œ</span><br>
            <span style="font-size: 11px; color: #888;">55ë¶„ê¹Œì§€ íˆ¬í‘œí•´ì•¼ ë‹¤ìŒ ì¸µìœ¼ë¡œ ì˜¬ë¼ê°‘ë‹ˆë‹¤.</span>
        </div>
    </div>

    <script>
        const firebaseConfig = { projectId: "sxsx-75c73", storageBucket: "sxsx-75c73.appspot.com" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const rewards = [10, 20, 30, 40, 50, 70, 90, 110, 130, 150, 200, 250, 300, 400, 500];
        let gameState = JSON.parse(localStorage.getItem('towerState')) || { currentFloor: 1, lastVotedRound: -1, selectedSide: null };
        let isWatchingMode = false;
        let lastLoadedFloor = null;
        let commentUnsubscribe = null;

        // [í•µì‹¬ ìˆ˜ì •] ìƒ‰ì¸ ì—ëŸ¬ë¥¼ í”¼í•˜ê¸° ìœ„í•´ ì •ë ¬ ë°©ì‹ì„ ë³€ê²½í–ˆìŠµë‹ˆë‹¤ ğŸŸ¡
        function fetchComments(floor) {
            if (lastLoadedFloor === floor) return;
            lastLoadedFloor = floor;
            if (commentUnsubscribe) commentUnsubscribe();

            // .orderBy("createdAt", "desc")ë¥¼ ì œê±°í•˜ì—¬ ìƒ‰ì¸ ì—†ì´ë„ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê²Œ í•©ë‹ˆë‹¤ âšª
            commentUnsubscribe = db.collection("tower_comments")
              .where("floor", "==", floor)
              .onSnapshot((snapshot) => {
                let comments = [];
                snapshot.forEach(doc => comments.push({id: doc.id, ...doc.data()}));
                
                // [ì¶”ê°€] ë¸Œë¼ìš°ì €(ìë°”ìŠ¤í¬ë¦½íŠ¸) ë‹¨ì—ì„œ ìµœì‹ ìˆœ ì •ë ¬ ğŸŸ¡
                comments.sort((a, b) => {
                    const timeA = a.createdAt?.seconds || 0;
                    const timeB = b.createdAt?.seconds || 0;
                    return timeB - timeA;
                });

                const best = [...comments].sort((a,b) => b.likes - a.likes).filter(c => c.likes > 0)[0];
                renderComments(comments, best);
            }, (error) => {
                console.error("ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨:", error);
            });
        }

        function renderComments(comments, best) {
            const list = document.getElementById('commentList');
            const bestList = document.getElementById('bestCommentList');
            list.innerHTML = "";
            bestList.innerHTML = best ? createCommentHTML(best, true) : "<div style='font-size:12px; color:#555;'>ì•„ì§ ë² ìŠ¤íŠ¸ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
            comments.forEach(c => list.innerHTML += createCommentHTML(c, false));
        }

        function createCommentHTML(c, isBest) {
            const date = c.createdAt ? new Date(c.createdAt.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "ë°©ê¸ˆ ì „";
            return `<div class="comment-card" style="${isBest ? 'border-color: #ffd700;' : ''}"><div class="comment-header"><span class="comment-user">${c.userName}</span><span>${date}</span></div><div class="comment-content">${c.text}</div><div class="comment-footer"><button class="like-btn" onclick="likeComment('${c.id}')">ğŸ‘ ${c.likes}</button></div></div>`;
        }

        function addComment() {
            if (isWatchingMode) return alert("ê³¼ê±° ì¸µì—ëŠ” íŒê²°ë¬¸ì„ ë‚¨ê¸¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            const input = document.getElementById('commentInput');
            const userData = JSON.parse(localStorage.getItem('userData')) || {nickname: "ìµëª…ì˜ ë“±ë°˜ì"};
            if(!input.value.trim()) return;

            db.collection("tower_comments").add({
                floor: gameState.currentFloor,
                userName: userData.nickname || "ìµëª…ì˜ ë“±ë°˜ì",
                text: input.value,
                likes: 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                input.value = "";
                addCoin(30);
                alert("íŒê²° ì™„ë£Œ! 30ì½”ì¸ì„ íšë“í–ˆìŠµë‹ˆë‹¤.");
            });
        }

        function fetchQuestion() {
            const hour = new Date().getHours();
            db.collection("tower_questions").doc("today").onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('debateQuestion').innerText = data[hour.toString()] || "ì œë¯¸ë‚˜ì´ê°€ ì£¼ì œë¥¼ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤...";
                }
            });
        }

        function updateGame() {
            const now = new Date();
            const hour = now.getHours();
            const min = now.getMinutes();

            if (hour >= 9 && hour <= 23) {
                const floor = hour - 8;
                if (gameState.currentFloor !== floor) {
                    gameState.currentFloor = floor;
                    if (!isWatchingMode) fetchComments(floor);
                }
            } else {
                document.getElementById('debateQuestion').innerText = "ì˜¤ì „ 9ì‹œì— ì˜¤í”ˆë©ë‹ˆë‹¤.";
                return;
            }

            if (!isWatchingMode) {
                document.getElementById('currentFloor').innerText = `${gameState.currentFloor}ì¸µ`;
                document.getElementById('rewardCoin').innerText = `${rewards[gameState.currentFloor-1]}ê°œ`;
                fetchComments(gameState.currentFloor);
            }

            const isVotePhase = min < 55;
            document.getElementById('roundTimer').innerText = isVotePhase ? `íˆ¬í‘œ ì¢…ë£Œê¹Œì§€ ${54 - min}ë¶„ ${59 - now.getSeconds()}ì´ˆ` : "ê²°ê³¼ í™•ì¸ ì¤‘...";
            document.getElementById('resultBox').style.display = isVotePhase ? 'none' : 'block';
            
            refreshButtons(isVotePhase, hour);
            updateCoinDisplay();
            renderFloorBar();
        }

        function castVote(side) {
            if (isWatchingMode || new Date().getMinutes() >= 55) return;
            gameState.lastVotedRound = new Date().getHours();
            gameState.selectedSide = side;
            addCoin(30);
            saveState();
            alert("íˆ¬í‘œ ì™„ë£Œ! 30ì½”ì¸ì„ íšë“í–ˆìŠµë‹ˆë‹¤.");
        }

        function refreshButtons(isVotePhase, hour) {
            const voted = gameState.lastVotedRound === hour;
            document.getElementById('btnMy').disabled = document.getElementById('btnYour').disabled = !isVotePhase || voted || isWatchingMode;
            document.getElementById('btnMy').classList.toggle('selected', gameState.selectedSide === 'my' && !isWatchingMode);
            document.getElementById('btnYour').classList.toggle('selected', gameState.selectedSide === 'your' && !isWatchingMode);
        }

        function renderFloorBar() {
            const bar = document.getElementById('floorBar');
            bar.innerHTML = '';
            for (let i = 1; i <= 15; i++) {
                let status = (i === gameState.currentFloor) ? 'current' : (i < gameState.currentFloor ? 'completed' : 'locked');
                const dot = document.createElement('div');
                dot.className = `floor-dot ${status}`;
                dot.innerText = i;
                dot.onclick = () => selectFloor(i);
                bar.appendChild(dot);
            }
        }

        function selectFloor(floor) {
            if (floor > gameState.currentFloor) return alert("ì ê²¨ìˆìŠµë‹ˆë‹¤.");
            isWatchingMode = (floor !== gameState.currentFloor);
            document.getElementById('currentFloor').innerText = `${floor}ì¸µ`;
            document.getElementById('voteGroup').style.opacity = isWatchingMode ? "0.3" : "1";
            fetchComments(floor);
            renderFloorBar();
        }

        function likeComment(id) { db.collection("tower_comments").doc(id).update({ likes: firebase.firestore.FieldValue.increment(1) }); }
        function addCoin(amount) {
            let u = JSON.parse(localStorage.getItem('userData')) || {coin: 0};
            u.coin += amount;
            localStorage.setItem('userData', JSON.stringify(u));
        }
        function updateCoinDisplay() {
            let u = JSON.parse(localStorage.getItem('userData')) || {coin: 0};
            document.getElementById('userCoinDisplay').innerText = `ğŸŸ¡ ${u.coin.toLocaleString()}`;
        }
        function saveState() { localStorage.setItem('towerState', JSON.stringify(gameState)); }

        fetchQuestion();
        fetchComments(gameState.currentFloor);
        setInterval(updateGame, 1000);
        updateGame();
    </script>
</body>
</html>